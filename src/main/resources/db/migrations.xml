<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">


    <changeSet id="0" author="lennartkoopmann">
        <createTable tableName="measurements" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="measurement_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="measurement_value" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="1" author="lennartkoopmann">
        <createIndex indexName="idx_measurements_standard_lookup" tableName="measurements" unique="false">
            <column name="measurement_type" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_measurements_created_at" tableName="measurements" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="2" author="lennartkoopmann">
        <createTable tableName="signal_index_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="signal_index" type="float">
                <constraints nullable="true" />
            </column>

            <column name="signal_index_threshold" type="float">
                <constraints nullable="true" />
            </column>

            <column name="signal_quality" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="signal_stddev" type="float">
                <constraints nullable="true" />
            </column>

            <column name="expected_delta_upper" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="expected_delta_lower" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sigindex_standard_lookup" tableName="signal_index_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_sigindex_created_at" tableName="signal_index_history" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="3" author="lennartkoopmann">
        <createTable tableName="beacon_rate_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="beacon_rate" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_beaconrate_standard_lookup" tableName="beacon_rate_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_beaconrate_created_at" tableName="beacon_rate_history" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="4" author="lennartkoopmann">
        <dropColumn tableName="beacon_rate_history" columnName="channel" />
    </changeSet>

    <changeSet id="5" author="lennartkoopmann">
        <dropTable tableName="signal_index_history" />
    </changeSet>

    <changeSet id="6" author="lennartkoopmann">
        <createTable tableName="sigidx_histogram_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="histogram" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sigidxhistory_standard_lookup" tableName="sigidx_histogram_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="7" author="lennartkoopmann">
        <createTable tableName="alerts" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="alert_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="alert_type" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="subsystem" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="message" type="text">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="fields" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="use_frame_count" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="documentation_link" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="false_positives" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="alerts_standard_lookup" tableName="alerts" unique="false">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="8" author="lennartkoopmann">
        <dropColumn tableName="alerts" columnName="false_positives" />
        <dropColumn tableName="alerts" columnName="documentation_link" />
        <dropColumn tableName="alerts" columnName="description" />
        <dropColumn tableName="alerts" columnName="message" />
    </changeSet>

    <changeSet id="9" author="lennartkoopmann">
        <addColumn tableName="alerts">
            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="antenna_signal" type="integer">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="10" author="lennartkoopmann">
        <dropColumn tableName="alerts" columnName="channel" />
        <dropColumn tableName="alerts" columnName="antenna_signal" />
        <dropColumn tableName="alerts" columnName="frequency" />
    </changeSet>

    <changeSet id="11" author="lennartkoopmann">
        <createTable tableName="bandits">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bandit_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="name" type="varchar(75)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="identifiers" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="bandits_standard_lookup" tableName="bandits" unique="false">
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="bandits_indiv_lookup" tableName="bandits" unique="false">
            <column name="bandit_uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="12" author="lennartkoopmann">
        <dropColumn tableName="bandits" columnName="identifiers" />

        <createTable tableName="bandit_identifiers">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="identifier_type" type="varchar(75)">
                <constraints nullable="false" />
            </column>

            <column name="bandit_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="configuration" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="bandits_identifiers_linked_lookup" tableName="bandit_identifiers" unique="false">
            <column name="bandit_id" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_bandits2identifiers"
                                    baseTableName="bandit_identifiers"
                                    baseColumnNames="bandit_id"
                                    referencedTableName="bandits"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />
    </changeSet>

    <changeSet id="13" author="lennartkoopmann">
        <createTable tableName="contacts">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="bandit_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="contacts_linked_lookup" tableName="contacts" unique="false">
            <column name="bandit_id" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_bandits2contacts"
                                    baseTableName="contacts"
                                    baseColumnNames="bandit_id"
                                    referencedTableName="bandits"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />

    </changeSet>

    <changeSet id="14" author="lennartkoopmann">
        <modifyDataType tableName="measurements" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="measurements" columnName="measurement_value" newDataType="bigint" />
        <modifyDataType tableName="beacon_rate_history" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="beacon_rate_history" columnName="beacon_rate" newDataType="bigint" />
        <modifyDataType tableName="sigidx_histogram_history" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="alerts" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="alerts" columnName="frame_count" newDataType="bigint" />
        <modifyDataType tableName="bandits" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="bandit_identifiers" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="bandit_identifiers" columnName="bandit_id" newDataType="bigint" />
    </changeSet>

    <changeSet id="15" author="lennartkoopmann">
        <createIndex indexName="contacts_active_lookup" tableName="contacts" unique="false">
            <column name="bandit_id" />
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="16" author="lennartkoopmann">
        <addColumn tableName="bandit_identifiers">
            <column name="identifier_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="17" author="lennartkoopmann">
        <addColumn tableName="bandits">
            <column name="read_only" type="boolean" defaultValue="false">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="18" author="lennartkoopmann">
        <addColumn tableName="contacts">
            <column name="source_role" type="varchar(75)" defaultValue="LEADER" >
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>

        <addColumn tableName="contacts">
            <column name="source_name" type="varchar(255)" defaultValue="unknown/migrated">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="19" author="lennartkoopmann">
        <addColumn tableName="contacts">
            <column name="last_signal" type="bigint" defaultValue="0">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20" author="lennartkoopmann">
        <createTable tableName="sentry_ssids" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sentry_ssids_standard_lookup" tableName="sentry_ssids" unique="false">
            <column name="ssid" />
        </createIndex>

        <createIndex indexName="idx_sentry_ssids_list_lookup" tableName="sentry_ssids" unique="false">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="21" author="lennartkoopmann">
        <createTable tableName="deauth_monitor" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="total_frame_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_deauth_frame_count_standard_lookup" tableName="deauth_monitor" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="22" author="lennartkoopmann">
        <sqlFile path="db/quartz.sql" />
    </changeSet>

    <changeSet id="23" author="lennartkoopmann">
        <createTable tableName="events" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="type" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_events_standard_lookup" tableName="events" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="24" author="lennartkoopmann">
        <createTable tableName="report_receivers_email" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="address" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_emails_standard_lookup" tableName="report_receivers_email" unique="false">
            <column name="report_name" />
        </createIndex>
    </changeSet>

    <changeSet id="25" author="lennartkoopmann">
        <createTable tableName="report_metadata" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_meta_standard_lookup" tableName="report_metadata" unique="false">
            <column name="report_name" />
        </createIndex>
    </changeSet>

    <changeSet id="26" author="lennartkoopmann">
        <createTable tableName="report_execution_log" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="result" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="message" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_log_standard_lookup" tableName="report_execution_log" unique="false">
            <column name="report_name" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="27" author="lennartkoopmann">
        <createTable tableName="reports" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="report" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_reports_standard_lookup" tableName="reports" unique="false">
            <column name="report_name" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="28" author="lennartkoopmann">
        <dropTable tableName="reports" />

        <addColumn tableName="report_execution_log">
            <column name="content" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="29" author="lennartkoopmann">
        <createTable tableName="contacts_ssids" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_contacts_ssids_standard_lookup" tableName="contacts_ssids" unique="false">
            <column name="contact_uuid" />
        </createIndex>

        <createIndex indexName="idx_contacts_ssids_upsert_lookup" tableName="contacts_ssids" unique="false">
            <column name="contact_uuid" />
            <column name="ssid" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_contacts2ssids"
                                    baseTableName="contacts_ssids"
                                    baseColumnNames="contact_uuid"
                                    referencedTableName="contacts"
                                    referencedColumnNames="contact_uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="30" author="lennartkoopmann">
        <createTable tableName="contact_records" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="record_type" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="record_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="rssi_average" type="double">
                <constraints nullable="false" />
            </column>

            <column name="rssi_stddev" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

        </createTable>

        <createIndex indexName="idx_contact_records_standard_lookup" tableName="contact_records" unique="false">
            <column name="contact_uuid" />
            <column name="record_type" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_contacts2records"
                                    baseTableName="contact_records"
                                    baseColumnNames="contact_uuid"
                                    referencedTableName="contacts"
                                    referencedColumnNames="contact_uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="31" author="lennartkoopmann">
        <dropTable tableName="contacts_ssids" />
    </changeSet>

    <changeSet id="32" author="lennartkoopmann">
        <addColumn tableName="contact_records">
            <column name="frame_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="33" author="lennartkoopmann">
        <createTable tableName="taps" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="local_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="processed_bytes_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="processed_bytes_10" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_free" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_used" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="cpu_load" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_taps_standard_lookup" tableName="taps" unique="false">
            <column name="name" />
        </createIndex>

        <createIndex indexName="idx_taps_active_lookup" tableName="taps" unique="false">
            <column name="name" />
            <column name="updated_at" />
        </createIndex>
    </changeSet>

    <changeSet id="34" author="lennartkoopmann">
        <createTable tableName="base_configuration" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_secret" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="35" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="description" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="36" author="lennartkoopmann">
        <renameColumn tableName="taps" oldColumnName="processed_bytes_10" newColumnName="processed_bytes_average" />
    </changeSet>

    <changeSet id="37" author="lennartkoopmann">
        <createTable tableName="tap_buses">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="taps" columnNames="name" />

        <addForeignKeyConstraint    constraintName="link_taps2buses"
                                    baseTableName="tap_buses"
                                    baseColumnNames="tap_name"
                                    referencedTableName="taps"
                                    referencedColumnNames="name"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="38" author="lennartkoopmann">
        <createTable tableName="bus_channels">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bus_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="capacity" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="watermark" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="errors_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="errors_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_bytes_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_bytes_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_messages_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_messages_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_buses2channels"
                                    baseTableName="bus_channels"
                                    baseColumnNames="bus_id"
                                    referencedTableName="tap_buses"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="39" author="lennartkoopmann">
        <addColumn tableName="tap_buses">
            <column name="name" type="varchar(255)" defaultValue="unknown">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="40" author="lennartkoopmann">
        <createTable tableName="tap_captures">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="interface" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="capture_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="is_running" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="received" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="dropped_buffer" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="dropped_interface" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="41" author="lennartkoopmann">
        <createTable tableName="dns_statistics">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="request_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="request_bytes" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="response_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="response_bytes" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="nxdomain_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="42" author="lennartkoopmann">
        <createTable tableName="dns_nxdomains_log">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="server" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="query_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="data_type" type="varchar(55)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="43" author="lennartkoopmann">
        <createTable tableName="metrics_gauges">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="metric_value" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="44" author="lennartkoopmann">
        <createIndex indexName="idx_metrics_std_lookup" tableName="metrics_gauges" unique="false">
            <column name="metric_name"/>
            <column name="tap_name"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="45" author="lennartkoopmann">
        <createTable tableName="dns_pairs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="server" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="46" author="lennartkoopmann">
        <addColumn tableName="dns_pairs">
            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="47" author="lennartkoopmann">
        <createIndex indexName="idx_dns_pairs_std_lookup" tableName="metrics_gauges" unique="false">
            <column name="tap_name"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="48" author="lennartkoopmann">
        <createTable tableName="registry">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="key" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="49" author="lennartkoopmann">
        <createTable tableName="crypto_keys">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="key_type" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="key_signature" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="50" author="lennartkoopmann">
        <createTable tableName="registry_encrypted">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="key" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key_signature" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="51" author="lennartkoopmann">
        <createTable tableName="nodes">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="transport_address" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="nodes" indexName="idx_node_uuid" unique="true">
            <column name="uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="52" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="version" type="varchar(50)" afterColumn="transport_address" defaultValue="0.0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="53" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="memory_bytes_total" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="memory_bytes_available" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="memory_bytes_used" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="cpu_system_load" type="double" defaultValue="0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="cpu_thread_count" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_start_time" type="timestamp with time zone" defaultValue="1970-01-01 00:00:00 America/Chicago">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_virtual_size" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_arguments" type="text" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="os_information" type="varchar(255)" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="54" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="heap_bytes_total" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="heap_bytes_available" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="heap_bytes_used" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="55" author="lennartkoopmann">
        <renameColumn tableName="nodes" oldColumnName="transport_address" newColumnName="http_external_uri" />
    </changeSet>

    <changeSet id="56" author="lennartkoopmann">
        <dropTable tableName="measurements" />
    </changeSet>

    <changeSet id="57" author="lennartkoopmann">
        <renameTable oldTableName="metrics_gauges" newTableName="tap_metrics_gauges" />
    </changeSet>

    <!-- Switching from numbers to text for migration IDs to avoid merge problems. -->

    <changeSet id="create_node_metrics" author="lennartkoopmann">
        <createTable tableName="node_metrics_gauges">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="metric_value" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_nodemetrics_std_lookup" tableName="node_metrics_gauges" unique="false">
            <column name="metric_name"/>
            <column name="node_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="drop_events" author="lennartkoopmann">
        <dropTable tableName="events" />
    </changeSet>

    <changeSet id="create_node_metrics_timers" author="lennartkoopmann">
        <createTable tableName="node_metrics_timers">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="metric_max" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_min" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_mean" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_p99" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_stddev" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_counter" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_nodemetricstimers_std_lookup" tableName="node_metrics_timers" unique="false">
            <column name="metric_name"/>
            <column name="node_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="change_node_metrics_timers_1" author="lennartkoopmann">
        <modifyDataType tableName="node_metrics_timers" columnName="metric_max" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_min" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_mean" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_p99" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_stddev" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_counter" newDataType="bigint" />
    </changeSet>

    <changeSet id="add_clock_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="clock" type="timestamp with time zone" defaultValue="1970-01-01 00:00:00 America/Chicago">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_health_indicators" author="lennartkoopmann">
        <createTable tableName="health_indicators">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="indicator_id" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="indicator_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="level" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="last_checked" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="make_health_indicators_id_unique" author="lennartkoopmann">
        <createIndex tableName="health_indicators" indexName="idx_healthindicators_indicatorid" unique="true">
            <column name="indicator_id" />
        </createIndex>
    </changeSet>

    <changeSet id="rename_tap_clock_column" author="lennartkoopmann">
        <renameColumn tableName="taps" oldColumnName="local_time" newColumnName="clock" />
    </changeSet>
    
    <changeSet id="add_node_id_to_crypto_keys_and_rename_node_name" author="lennartkoopmann">
        <renameColumn tableName="crypto_keys" oldColumnName="node" newColumnName="node_name" />

        <addColumn tableName="crypto_keys">
            <column name="node_id" type="uuid" defaultValueComputed="gen_random_uuid()" afterColumn="node_name">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_deleted_field_to_nodes_and_taps" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="deleted" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="deleted" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_deactivation_to_health_indicators" author="lennartkoopmann">
        <addColumn tableName="health_indicators">
            <column name="active" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tls_cert_table" author="lennartkoopmann">
        <createTable tableName="crypto_tls_certificates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="certificate" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key" type="text">
                <constraints nullable="false" />
            </column>

            <column name="valid_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_listen_uri_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="http_listen_uri" type="varchar(255)" defaultValue="https://0.0.0.0:22900">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_source_type_to_tls_certs" author="lennartkoopmann">
        <addColumn tableName="crypto_tls_certificates">
            <column name="source_type" type="varchar(50)" defaultValue="TEST">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tls_wildcard_cert_table" author="lennartkoopmann">
        <createTable tableName="crypto_tls_certificates_wildcard">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_matcher" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="certificate" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key" type="text">
                <constraints nullable="false" />
            </column>

            <column name="valid_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="source_type" type="varchar(50)" defaultValue="TEST">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_message_bus_messages_table" author="lennartkoopmann">
        <createTable tableName="message_bus_messages">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sender_node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="receiver_node_id" type="uuid" />

            <column name="type" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="parameters" type="text" />

            <column name="status" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="cycle_limiter" type="bigint" />

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="acknowledged_at" type="timestamp with time zone" />
        </createTable>
    </changeSet>

    <changeSet id="add_node_cylces" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="cycle" type="bigint" defaultValue="1">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_lookup_index_to_messagebus" author="lennartkoopmann">
        <createIndex indexName="idx_msgbus_std_lookup" tableName="message_bus_messages" unique="false">
            <column name="receiver_node_id" />
            <column name="status" />
            <column name="cycle_limiter" />
        </createIndex>

        <createIndex indexName="idx_msgbus_nack_lookup" tableName="message_bus_messages" unique="false">
            <column name="status" />
        </createIndex>
    </changeSet>

    <changeSet id="add_tasks_queue_table" author="lennartkoopmann">
        <createTable tableName="tasks_queue">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sender_node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="type" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="max_attempts" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="allow_retry" type="boolean" >
                <constraints nullable="false" />
            </column>

            <column name="parameters" type="text" />

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="status" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="attempts" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="processing_time_ms" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="first_processed_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_processed_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_tskque_status_lookup" tableName="tasks_queue" unique="false">
            <column name="status" />
        </createIndex>
    </changeSet>

</databaseChangeLog>